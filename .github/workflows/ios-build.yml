name: iOS Build

on:
  pull_request:
    paths:
      - "apps/ios/**"
      - "apps/shared/**"
      - ".github/workflows/ios-build.yml"
  push:
    branches:
      - main
    paths:
      - "apps/ios/**"
      - "apps/shared/**"

jobs:
  build:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -switch /Applications/Xcode.app/Contents/Developer

      - name: Install dependencies
        run: |
          cd apps/ios
          if [ -f "Package.swift" ]; then
            swift package resolve
          fi

      - name: Generate Xcode project
        run: |
          if command -v xcodegen &> /dev/null; then
            cd apps/ios
            xcodegen generate
          else
            echo "xcodegen not installed, skipping project generation"
          fi

      - name: Build iOS app
        run: |
          cd apps/ios
          xcodebuild -scheme OpenClaw \
            -destination 'platform=iOS Simulator,name=iPhone 16' \
            clean build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Run tests (if available)
        run: |
          cd apps/ios
          xcodebuild test \
            -scheme OpenClaw \
            -destination 'platform=iOS Simulator,name=iPhone 16' \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            || echo "Tests failed or no tests found"
